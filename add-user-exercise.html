<!DOCTYPE html>
<html lang="en">

<head>
  <title>Area Sports || Add Routine</title>
  <meta charset="utf-8">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/images/company-logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/images/company-logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/images/company-logo.png">
  <link rel="manifest" href="assets/site.webmanifest">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="assets/css/customStyle.css?v=1.0">
  <style>
    h1 {
      color: #285475;
      font-size: 5rem;
      text-align: center;
    }

    .bgSquare {
      height: 215px;
    }

    .bg-theme {
      background-color: #ee5023;
    }

    .fw-b {
      font-weight: bold;
    }

    .fa:hover {
      cursor: pointer;
    }

    .no-of-set,
    .no-of-reps,
    .no-of-exercise {
      min-width: 4rem;
    }

    .thead-basic {
      background-color: #566696
    }
  </style>
</head>

<body>


  <section class="entry-form-sec">
    <div class="container">
      <div class="bgSquare"></div>
      <div class="entry-form bg-image" id="entry-form">
        <div class="col-md-12 img-div d-none">
          <img class="logoForm" src="" alt="company logo">
        </div>
        <form
          action="https://script.google.com/macros/s/AKfycbwsG_udq5z9GwE1EcDvAN28280UN8aQ-EdSoIwJVglpW5VbCESV6OXuph5ayFTwQt_DGw/exec"
          class="formValues" method="POST" id="formValues">
          <div class="row login-form">
            <div class="col-md-3"></div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="">Name</label>
                <input class="form-control required" name="name">
              </div>
            </div>
            <div class="col-md-3"></div>
            <div class="col-md-3"></div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="">Password</label>
                <input type="password" class="form-control password required" name="password">
              </div>
            </div>
            <div class="col-md-3"></div>
            <div class="d-flex justify-content-end">
              <div class="col-md-4">
                <button type="button" class="btn btn-primary mt-3 next-btn">Next</button>
              </div>
            </div>
          </div>
          <div class="row login-depend d-none">

            <h3>Add Routine for <span class="month"></span> <span class="year"></span></h3>
            <input type="hidden" name="form_name" value="user_exercise">
            <input type="hidden" class="check-user" name="check_user" value="yes">
            <input type="hidden" name="type" value="owner">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="">Users</label>
                <select class="form-control select2 users required empty-select" name="user">
                  <option value="" selected disabled>Select option</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="">Routine</label>
                <select class="form-control select2 routine required empty-select" name="routine">
                  <option value="" selected disabled>Select option</option>
                </select>
              </div>
            </div>
            <div class="col-12 mb-3 table-responsive">
              <table class="form-tabel table">
                <thead class="thead-basic ">
                  <tr>
                    <th colspan="2" width="100%">Note</th>
                  </tr>
                </thead>
                <tbody class="mov-prep-tbody"></tbody>
              </table>
            </div>
            <div class="col-12 table-responsive">
              <table class="form-tabel table">
                <thead class="thead-basic">
                  <tr>
                    <th width="50%">Exercise</th>
                    <th width="13%">Sets</th>
                    <th width="14%">Reps</th>
                    <th width="13%">No. exercise</th>
                  </tr>
                </thead>
                <tbody class="products"></tbody>
              </table>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-primary mt-3 btn-submit" disabled>Submit</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>
  <footer>
    <div class="container">
      <div class="site-info">
        <a><img src="assets/images/company-logo.png" /></a>
        <p>
          COPYRIGHT ©
          <script>
            document.write(new Date().getFullYear());
          </script>
        </p>
        <p>
          <a>AREA Sports Development System™ </a>
        </p>
        </p>
        <p>All rights Reserved</p>
      </div>
    </div>
  </footer>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script src="https://kit.fontawesome.com/786d0bd98a.js" crossorigin="anonymous"></script>
  <script src="assets/js/sweet-alert.js"></script>
  <script src="assets/js/ResizeSensor.js"></script>
  <script src="assets/js/custom.js"></script>
  <script>
    var excercise_option = '',
      move_prep_option = '',
      user_data = '',
      all_routines = ''

    function appendRow(excercise_option) {
      $('.products').append(`
    <tr>
      <td>
        <div>
          <select class="form-control select2 exercises required empty-select" name="exercise">
            <option value="" selected disabled>Select option</option>
            ` + excercise_option + `
          </select>
        </div>
      </td>
      <td>
        <div>
          <input type="text" class="form-control no-of-set number required empty-input" name="no_of_set">
        </div>
      </td>
      <td>
        <div>
          <input type="text" class="form-control no-of-reps number required empty-input" name="no_of_reps">
        </div>
      </td>
      <td>
        <div>
          <input type="text" class="form-control no-of-exercise required empty-input" name="no_of_exercise">
        </div>
      </td>
    </tr>
    <tr>
      <td colspan="3">
        <div>
          <select class="form-control select2 day required empty-select" multiple="multiple">
            <optgroup label="Add days">
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
              <option value="Sunday">Sunday</option>
            </optgroup>
          </select>
          <input type="hidden" name="day" class="add-days">
        </div>
      </td>
      <td>
        <i class="fa fa-plus bg-success text-light p-1 add-exercise"></i>
      </td>
    </tr>
  `)
      $("select.select2-hidden-accessible").select2('destroy');
      $('.select2').select2({
        width: '100%'
      });
    }

    $(document).on('change', '.day', function () {
      var value = $(this).val()
      $(this).closest('tr').find('.add-days').val(value)
    })


    function appendMovPrep(mov_preps) {
      $('.mov-prep-tbody').append(`
    <tr>
      <td width="100%" colspan="2">
        <div>
          <textarea class="form-control required note" name="note" rows="2" style="height:auto;"></textarea>
        </div>
      </td>
    </tr>
    <tr>
      <td width="90%">
        <div>
          <select class="form-control select2 day required empty-select" multiple="multiple">
            <optgroup label="Add days">
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
              <option value="Sunday">Sunday</option>
            </optgroup>
          </select>
          <input type="hidden" name="mov_day" class="add-days">
        </div>
      </td>
      <td width="10%">
        <i class="fa fa-plus bg-success text-light p-1 mov-prep-add"></i>
      </td>
    </tr>
  `)
      $("select.select2-hidden-accessible").select2('destroy');
      $('.select2').select2({
        width: '100%'
      });
    }

    $(document).on('click', '.fa-trash', function () {
      $(this).closest('tr').prev('tr').remove()
      $(this).closest('tr').remove()
    })

    function appendData(exercises, users, mov_preps) {
      excercise_option = '', move_prep_option = ''
      for (var i = 0; i < exercises.length; i++) {
        excercise_option += '<option value="' + exercises[i][0] + '">' + exercises[i][0] + '</option>'
      }

      for (var i = 0; i < mov_preps.length; i++) {
        move_prep_option += '<option value="' + mov_preps[i][0] + '">' + mov_preps[i][0] + '</option>'
      }

      for (var i = 0; i < users.length; i++) {
        if (users[i][2] == "client")
          $('.users').append('<option value="' + users[i][0] + '">' + users[i][0] + '</option>')
      }

      appendRow(excercise_option)
      appendMovPrep(move_prep_option)
    }


    $(document).on('change', '.routine', function () {
      $('.mov-prep-tbody, .products').empty()
      appendMovPrep(move_prep_option)
      appendRow(excercise_option)

      if ($(this).find(":selected").val() != "") {
        var flag = true,
          exercise_flag = true

        for (var i = 0; i < all_routines.length; i++) {
          if ($(this).find(":selected").val() == all_routines[i][0]) {
            if (all_routines[i][4] == "note") {
              var prev_tr = $('.mov-prep-tbody').find('tr:last').prev('tr'),
                tr = $('.mov-prep-tbody').find('tr:last')
              prev_tr.find('.note').val(all_routines[i][1])

              var day_arr = all_routines[i][6].split(",")
              for (var j = 0; j < day_arr.length; j++) {
                tr.find('.day option[value="' + day_arr[j].trim() + '"]').prop('selected', true).change()
              }

              $('.mov-prep-add').click()

              flag = false
            }
          }
        }
        if (!flag) {
          $('.mov-prep-tbody').find('tr:last').prev('tr').remove()
          $('.mov-prep-tbody').find('tr:last').remove()
          $('.mov-prep-tbody').find('tr:last').find('.fa-trash').addClass('fa-plus bg-success mov-prep-add')
          $('.mov-prep-tbody').find('tr:last').find('.fa-trash').removeClass('fa-trash bg-danger')
        }

        for (var i = 0; i < all_routines.length; i++) {
          if ($(this).find(":selected").val() == all_routines[i][0]) {
            if (all_routines[i][4] == "exercise") {
              var prev_tr = $('.products').find('tr:last').prev('tr'),
                tr = $('.products').find('tr:last')
              console.log(all_routines[i][1])
              prev_tr.find('.exercises option[value="' + all_routines[i][1] + '"]').prop('selected', true).change()
              prev_tr.find('.no-of-set').val(all_routines[i][2])
              prev_tr.find('.no-of-reps').val(all_routines[i][3])
              prev_tr.find('.no-of-exercise').val(all_routines[i][5])

              var day_arr = all_routines[i][6].split(",")
              for (var j = 0; j < day_arr.length; j++) {
                tr.find('.day option[value="' + day_arr[j].trim() + '"]').prop('selected', true).change()
              }

              // const daysString = user_data[i][6]; 

              // const selectedDays = daysString.split(', ').map(day => day.trim()); // ["Tuesday", "Monday"]
              // console.log(selectedDays)


              $('.add-exercise').click()

              exercise_flag = false
            }
          }
        }
        if (!exercise_flag) {
          $('.products').find('tr:last').prev('tr').remove()
          $('.products').find('tr:last').remove()
          $('.products').find('tr:last').find('.fa-trash').addClass('fa-plus bg-success add-exercise')
          $('.products').find('tr:last').find('.fa-trash').removeClass('fa-trash bg-danger')
        }
      }

    })


    $(document).on('change', '.users', function () {
      $('.mov-prep-tbody, .products').empty()
      $('.routine option[value=""]').prop('selected', true)
      appendMovPrep(move_prep_option)
      appendRow(excercise_option)

      if ($(this).find(":selected").val() != "") {
        var flag = true,
          exercise_flag = true

        for (var i = 0; i < user_data.length; i++) {
          if ($(this).find(":selected").val() == user_data[i][0]) {
            if (user_data[i][4] == "note") {
              var prev_tr = $('.mov-prep-tbody').find('tr:last').prev('tr'),
                tr = $('.mov-prep-tbody').find('tr:last')
              prev_tr.find('.note').val(user_data[i][1])

              var day_arr = user_data[i][6].split(",")
              for (var j = 0; j < day_arr.length; j++) {
                tr.find('.day option[value="' + day_arr[j].trim() + '"]').prop('selected', true).change()
              }

              $('.mov-prep-add').click()

              flag = false
            }
          }
        }
        if (!flag) {
          $('.mov-prep-tbody').find('tr:last').prev('tr').remove()
          $('.mov-prep-tbody').find('tr:last').remove()
          $('.mov-prep-tbody').find('tr:last').find('.fa-trash').addClass('fa-plus bg-success mov-prep-add')
          $('.mov-prep-tbody').find('tr:last').find('.fa-trash').removeClass('fa-trash bg-danger')
        }

        for (var i = 0; i < user_data.length; i++) {
          if ($(this).find(":selected").val() == user_data[i][0]) {
            if (user_data[i][4] == "exercise") {
              var prev_tr = $('.products').find('tr:last').prev('tr'),
                tr = $('.products').find('tr:last')
              console.log(user_data[i][1])
              prev_tr.find('.exercises option[value="' + user_data[i][1] + '"]').prop('selected', true).change()
              prev_tr.find('.no-of-set').val(user_data[i][2])
              prev_tr.find('.no-of-reps').val(user_data[i][3])
              prev_tr.find('.no-of-exercise').val(user_data[i][5])

              var day_arr = user_data[i][6].split(",")
              for (var j = 0; j < day_arr.length; j++) {
                tr.find('.day option[value="' + day_arr[j].trim() + '"]').prop('selected', true).change()
              }

              // const daysString = user_data[i][6]; 

              // const selectedDays = daysString.split(', ').map(day => day.trim()); // ["Tuesday", "Monday"]
              // console.log(selectedDays)


              $('.add-exercise').click()

              exercise_flag = false
            }
          }
        }
        if (!exercise_flag) {
          $('.products').find('tr:last').prev('tr').remove()
          $('.products').find('tr:last').remove()
          $('.products').find('tr:last').find('.fa-trash').addClass('fa-plus bg-success add-exercise')
          $('.products').find('tr:last').find('.fa-trash').removeClass('fa-trash bg-danger')
        }
      }

    })

    $(document).on('click', '.add-exercise', function () {
      $(this).addClass('fa-trash bg-danger')
      $(this).removeClass('fa-plus bg-success add-exercise')
      appendRow(excercise_option)
    })

    $(document).on('click', '.mov-prep-add', function () {
      $(this).addClass('fa-trash bg-danger')
      $(this).removeClass('fa-plus bg-success mov-prep-add')
      appendMovPrep(move_prep_option)
    })

    function appendRoutine(routines)
    {
      var routine = [];
      $('.routine').empty()
      $('.routine').append('<option value="" selected disabled>Select option</option>')
      for(var i=0; i<routines.length; i++){
        if(routine.indexOf(routines[i][0]) == -1){
          $('.routine').append(`<option value="${routines[i][0]}">${routines[i][0]}</option>`)
          routine.push(routines[i][0])
        }
      }
    }

    // check password
    $(document).on('click', '.next-btn', function (e) {
      e.preventDefault();

      if (!validate()) {
        return false;
      }

      var form = $("#formValues");
      $('.next-btn').attr('disabled', 'disabled');
      $('.next-btn').text('Checking password...');
      var url_gsheet = $('#formValues').attr("action");

      $.ajax({
        type: "POST",
        url: url_gsheet,
        data: $(form).serialize(),
        success: function (response) {
          if (response.result == "success") {
            $('.login-depend').removeClass('d-none')
            $('.login-form').addClass('d-none')
            appendData(response.exercises, response.users, response.mov_preps)
            appendRoutine(response.routines)
            user_data = response.month_data
            all_routines = response.routines
            $('.btn-submit').removeAttr('disabled')
            $('.check-user').val('no')
            $('.logoForm').attr("src", "./assets/images/company-logo.png")
            $('.bg-image').removeClass('bg-image')
            $('.formValues').removeClass('formValues')
            $('.img-div').removeClass('d-none')
          } else if (response.result == "not match") {
            Swal.fire({
              title: "Error!",
              text: "Wrong Credentials",
              icon: "error",
            }).then(function () {
              $('.next-btn').removeAttr('disabled');
              $('.next-btn').text('Next');
            });
          } else {
            Swal.fire({
              title: "Error!",
              text: response.error,
              icon: "error",
            }).then(function () {
              $('.next-btn').removeAttr('disabled');
              $('.next-btn').text('Next');
            });
          }
        },
        error: function (response) {
          Swal.fire({
            title: "Error!",
            text: "Something went wrong",
            icon: "error",
          }).then(function () {
            $('.next-btn').removeAttr('disabled');
            $('.next-btn').text('Next');
          });
        }
      });
    })

    $(document).on('click', '.btn-submit', function (e) {
      e.preventDefault();

      if (!validate()) {
        return false;
      }

      var form = $("#formValues");
      $('.btn-submit').attr('disabled', 'disabled');
      $('.btn-submit').text('Please wait...');
      var url_gsheet = $('#formValues').attr("action");
      $.ajax({
        type: "POST",
        url: url_gsheet,
        data: $(form).serialize(),
        success: function (response) {
          if (response.result == "success") {
            Swal.fire({
              title: "Good Job!",
              text: "Thank you for submitting",
              icon: "success",
            })
              .then(function () {
                $('.btn-submit').removeAttr('disabled');
                $('.btn-submit').text('Submit');
                user_data = response.data
                $('.users option[value=""]').prop('selected', true).change()
                $('.routine option[value=""]').prop('selected', true).change()
              });
            setTimeout(function () {
              $('.btn-submit').removeAttr('disabled');
              $('.btn-submit').text('Submit');
              user_data = response.data
              $('.users option[value=""]').prop('selected', true).change()
              $('.routine option[value=""]').prop('selected', true).change()
            }, 3000);
          } else {
            Swal.fire({
              title: "Error!",
              text: response.error,
              icon: "error",
            }).then(function () {
              $('.btn-submit').removeAttr('disabled');
              $('.btn-submit').text('Submit Again');
            });
          }
        },
        error: function (response) {
          Swal.fire({
            title: "Error!",
            text: "Something went wrong",
            icon: "error",
          }).then(function () {
            $('.btn-submit').removeAttr('disabled');
            $('.btn-submit').text('Submit Again');
          });
        }
      });
    });
  </script>
</body>

</html>